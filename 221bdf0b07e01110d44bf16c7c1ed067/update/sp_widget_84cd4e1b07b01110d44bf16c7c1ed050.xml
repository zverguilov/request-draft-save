<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller = function ($scope) {
	/* widget controller */
	var c = this;
	c.variables = [];
	var redirectionPage = $scope.data.redirectionPage;
	var draftPage = $scope.data.draftPage;

	//Initial sync
	$scope.data.payload.forEach(function (e) {
		if (e.value) $scope.page.g_form.setValue(e.name, e.value);
	})

	//10-second draft rolling auto-save
	c.variables = $scope.data.varList;
	c.data.item = $scope.data.draftItem;

	var interval = setInterval(function () {

		var page = window.location.href.split('id=')[1].split('&')[0];

		if (page == draftPage) {
			c.data.payload = c.variables.reduce(function (acc, curr) {
				acc.push({
					name: curr,
					value: $scope.page.g_form.getValue(curr)
				});
				return acc;
			}, []);

			c.server.update();

			return;
		}

		var table = window.location.href.split('table=')[1] ?
			window.location.href.split('table=')[1].split('&')[0] : ''

		if (table && page == redirectionPage) {
			c.data.remove = true;
			c.data.table = table;
			c.server.update().then(function (res) {
				clearInterval(interval);
			})

			return;
		}

		c.data.catItemCut = true;
		clearInterval(interval);

	}, 10000);
};]]></client_script>
        <controller_as>c</controller_as>
        <css/>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>x_463716_rp_draft_save</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>RP Draft Save</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
	var utils = new x_463716_rp_draft.RPDraftUtills();
	var itemID = $sp.getParameter('sys_id');
	data.item = itemID
	data.page = $sp.getParameter('id');

	if(!input || !input.catItemCut && !input.remove) {
		data.draft = utils.getDraft(itemID, gs.getUserID()) || utils.createDraft(itemID, gs.getUserID())

		if(!data.draft) return;

		data.payload = data.draft.getValue('payload') ? JSON.parse(data.draft.getValue('payload')) : [];
		data.excludedVarList = utils.getExcluded(itemID);
		data.draftPage = data.draft.getDisplayValue('item_page') || 'sc_cat_item';
		data.redirectionPage = data.draft.getDisplayValue('redirection_page') || 'ticket';
		data.draftItem = data.draft.getValue('item')
		data.varList = utils.getVariables(itemID)
			.filter(function(variable) {
			return !data.excludedVarList.some(function(e) {
				return variable.id == e;
			})
		}).map(function(e) {
			return e.name;
		});

		if(data.page == data.draftPage) {
			if(input && input.payload && input.item) {
				data.draft.setValue('payload', JSON.stringify(input.payload));
				if(input.item == data.draftItem) data.draft.update();
			}
		}
	}

	if(input && input.remove) {
		utils.deleteDraft('', gs.getUserID(), input.table);
		return;
	}
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>zdravko.verguilov</sys_created_by>
        <sys_created_on>2022-07-25 11:22:19</sys_created_on>
        <sys_id>84cd4e1b07b01110d44bf16c7c1ed050</sys_id>
        <sys_mod_count>121</sys_mod_count>
        <sys_name>RP Draft Save</sys_name>
        <sys_package display_value="RP Draft" source="x_463716_rp_draft">221bdf0b07e01110d44bf16c7c1ed067</sys_package>
        <sys_policy/>
        <sys_scope display_value="RP Draft">221bdf0b07e01110d44bf16c7c1ed067</sys_scope>
        <sys_update_name>sp_widget_84cd4e1b07b01110d44bf16c7c1ed050</sys_update_name>
        <sys_updated_by>zdravko.verguilov</sys_updated_by>
        <sys_updated_on>2022-08-11 11:01:52</sys_updated_on>
        <template><![CDATA[<div>
<!-- your widget template -->
</div>]]></template>
    </sp_widget>
</record_update>
